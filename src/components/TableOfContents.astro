---
import { getHeadings } from "astro:content";

const { headings } = Astro.props;

function buildTree(headings) {
    const root = [];
    const stack = [{ level: 0, children: root, number: "" }];

    for (let i = 0; i < headings.length; i++) {
        const heading = headings[i];

        while (
            stack.length > 1 &&
            stack[stack.length - 1].level >= heading.depth
        ) {
            stack.pop();
        }

        const parent = stack[stack.length - 1];
        const number = parent.children.length + 1;
        const fullNumber = parent.number
            ? `${parent.number}.${number}`
            : `${number}`;

        const node = { ...heading, children: [], number: fullNumber };
        parent.children.push(node);
        stack.push({ ...node, level: heading.depth });
    }

    return root;
}

const tocTree = buildTree(headings);
---

<div
    class="hidden xl:flex fixed left-6 top-28 w-56 h-auto bg-mantle rounded-md border border-accent/40 shadow-md flex-col gap-y-4 font-space px-3 py-3"
>
    <ul class="pl-2 list-none">
        {
            tocTree.map((item) => (
                <li class="pl-2 text-lg font-bold mt-2 first:mt-0">
                    <a
                        href={`#${item.slug}`}
                        class="text-grey hover:underline hover:text-accent transition"
                    >
                        {item.number}. {item.text}
                    </a>
                    {item.children.length > 0 && (
                        <ul class="ml-4 pl-4 border-l-2 border-accent/40 py-1 space-y-2 text-base font-normal mt-2">
                            {item.children.map((subItem) => (
                                <li class="">
                                    <a
                                        href={`#${subItem.slug}`}
                                        class="text-grey hover:underline"
                                    >
                                        {subItem.number}. {subItem.text}
                                    </a>
                                </li>
                            ))}
                        </ul>
                    )}
                </li>
            ))
        }
    </ul>
</div>
